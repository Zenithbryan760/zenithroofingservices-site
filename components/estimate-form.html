<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estimate Form</title>
  <style>
    /* Base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #2c3e50;
      background-color: #f8f9fa;
      padding: 20px;
    }
    
    /* Form container */
    #estimate-form {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    /* Form rows and columns */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 20px;
      gap: 20px;
    }
    
    .form-group {
      flex: 1;
      min-width: 0;
    }
    
    .form-col-6 {
      flex: 0 0 calc(50% - 10px);
    }
    
    .form-col-4 {
      flex: 0 0 calc(33.333% - 14px);
    }
    
    /* Labels */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* Input fields, selects, and textarea */
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 16px;
      transition: all 0.3s ease;
      background-color: #fff;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #FF7700;
      box-shadow: 0 0 0 3px rgba(255, 119, 0, 0.2);
    }
    
    input::placeholder, textarea::placeholder {
      color: #9ca3af;
    }
    
    /* File input styling */
    input[type="file"] {
      padding: 10px;
      background-color: #f9fafb;
    }
    
    /* Select dropdown styling */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 16px;
      padding-right: 40px;
    }
    
    /* Zenith Orange button */
    .zenith-btn {
      display: block;
      width: 100%;
      padding: 15px;
      background-color: #FF7700;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    
    .zenith-btn:hover {
      background-color: #E06A00;
      transform: translateY(-2px);
    }
    
    .zenith-btn:active {
      transform: translateY(0);
    }
    
    /* reCAPTCHA container */
    .recaptcha-container {
      display: flex;
      justify-content: center;
    }
    
    /* Disclaimer text */
    .form-disclaimer {
      margin-top: 25px;
      padding: 15px;
      background-color: #f3f4f6;
      border-left: 4px solid #1A2B4F;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .form-disclaimer a {
      color: #FF7700;
      text-decoration: none;
      font-weight: 500;
    }
    
    .form-disclaimer a:hover {
      text-decoration: underline;
    }
    
    /* Validation styles */
    input:invalid, select:invalid, textarea:invalid {
      border-color: #e53e3e;
    }
    
    input:valid, select:valid, textarea:valid {
      border-color: #38a169;
    }
    
    /* Error message */
    .form-error-summary {
      margin: 10px 0;
      font-size: 0.95rem;
      line-height: 1.3;
      color: #b00020;
      display: none;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .form-col-6,
      .form-col-4 {
        flex: 0 0 100%;
      }
      
      #estimate-form {
        padding: 20px;
      }
    }
  </style>
</head>
<body>

  <!-- ===== Form ===== -->
  <form id="estimate-form" method="POST" novalidate>
    <!-- Row 1 -->
    <div class="form-row">
      <div class="form-group form-col-6">
        <label for="firstName" class="sr-only">First Name*</label>
        <input type="text" id="firstName" name="first_name" placeholder="First Name*" autocomplete="given-name" required />
      </div>
      <div class="form-group form-col-6">
        <label for="lastName" class="sr-only">Last Name*</label>
        <input type="text" id="lastName" name="last_name" placeholder="Last Name*" autocomplete="family-name" required />
      </div>
    </div>

    <!-- Row 2 -->
    <div class="form-row">
      <div class="form-group form-col-6">
        <label for="phone" class="sr-only">Phone Number*</label>
        <input type="tel" id="phone" name="phone" inputmode="tel" placeholder="Phone Number*" pattern="[\d\s\-\(\)\.]{10,}" autocomplete="tel" required />
      </div>
      <div class="form-group form-col-6">
        <label for="email" class="sr-only">Email Address*</label>
        <input type="email" id="email" name="email" placeholder="Email Address*" autocomplete="email" required />
      </div>
    </div>

    <!-- Row 3 -->
    <div class="form-row">
      <div class="form-group">
        <label for="streetAddress" class="sr-only">Street Address*</label>
        <input type="text" id="streetAddress" name="street_address" placeholder="Street Address*" autocomplete="address-line1" required />
      </div>
    </div>

    <!-- Row 4 -->
    <div class="form-row">
      <div class="form-group form-col-4">
        <label for="city" class="sr-only">City*</label>
        <input type="text" id="city" name="city" placeholder="City*" autocomplete="address-level2" required />
      </div>
      <div class="form-group form-col-4">
        <label for="state" class="sr-only">State*</label>
        <input type="text" id="state" name="state" value="CA" placeholder="State*" readonly />
      </div>
      <div class="form-group form-col-4">
        <label for="zip" class="sr-only">ZIP Code*</label>
        <input type="text" id="zip" name="zip" placeholder="ZIP Code*" inputmode="numeric" pattern="\d{5}(-\d{4})?" maxlength="10" autocomplete="postal-code" required />
      </div>
    </div>

    <!-- Row 5 -->
    <div class="form-row">
      <div class="form-group form-col-4">
        <label for="photos" class="sr-only">Upload Photos</label>
        <input type="file" id="photos" name="photos" accept="image/*" multiple />
      </div>
      <div class="form-group form-col-4">
        <label for="serviceType" class="sr-only">Service Type*</label>
        <select id="serviceType" name="service_type" required>
          <option value="" selected disabled hidden>Service Type*</option>
          <option>Roof Replacement</option>
          <option>Roof Repair</option>
          <option>Gutters</option>
          <option>Roof Maintenance</option>
          <option>Commercial Roofing</option>
          <option>Residential Roofing</option>
          <option>Other</option>
        </select>
      </div>
      <div class="form-group form-col-4">
        <label for="referral" class="sr-only">How did you hear about us?*</label>
        <select id="referral" name="referral_source" required>
          <option value="" selected disabled hidden>How did you hear about us?*</option>
          <option>Google</option>
          <option>Yelp</option>
          <option>Angi</option>
          <option>Social Media</option>
          <option>Referral</option>
          <option>Other</option>
        </select>
      </div>
    </div>

    <!-- Row 6 -->
    <div class="form-row">
      <div class="form-group">
        <label for="description" class="sr-only">Brief Description*</label>
        <textarea id="description" name="description" rows="4" placeholder="Brief Description* — tell us what you need help with" required></textarea>
      </div>
    </div>

    <!-- reCAPTCHA (classic v2 Checkbox) -->
    <div class="form-row">
      <div class="form-group recaptcha-container">
        <div
          id="recaptcha"
          class="g-recaptcha"
          data-sitekey="6LfD_borAAAAAFEtGO9x__VXAbvSjDYRiVaVpea5"
          aria-label="reCAPTCHA widget"></div>
      </div>
    </div>

    <!-- Submit -->
    <div class="form-row">
      <button type="submit" class="zenith-btn">Request Free Estimate</button>
    </div>

    <!-- Disclaimer -->
    <p class="form-disclaimer">
      <em>*Free estimates are not available for real estate transactions. If you're a real estate professional, buyer, or seller seeking a roof report, visual inspection, or verbal estimate for a transaction, please see our
      <a href="#real-estate">Real Estate Services</a>.</em>
    </p>
  </form>

  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <script>
    /* =========================================================
       Zenith – Hero Estimate Form Logic
       File: /js/hero.js
       Safe to include on any page. Looks for #estimate-form.
       ========================================================= */

    (() => {
      'use strict';

      // ---------- Tiny helpers ----------
      const $ = (sel, root = document) => root.querySelector(sel);
      const $$ = (sel, root = document) => [...root.querySelectorAll(sel)];
      const debounce = (fn, wait = 300) => {            // NEW
        let t;                                          // NEW
        return (...args) => {                           // NEW
          clearTimeout(t);                              // NEW
          t = setTimeout(() => fn(...args), wait);      // NEW
        };                                              // NEW
      };                                                // NEW

      // Create (or get) a compact error box near the submit button
      function ensureErrorSummary(form) {
        let box = $('.form-error-summary', form);
        if (!box) {
          box = document.createElement('div');
          box.className = 'form-error-summary';
          box.style.margin = '10px 0';
          box.style.fontSize = '0.95rem';
          box.style.lineHeight = '1.3';
          box.style.color = '#b00020';
          box.style.display = 'none';
          const submitRow = form.querySelector('button[type="submit"]')?.parentElement || form;
          submitRow.parentNode.insertBefore(box, submitRow);
        }
        return box;
      }
      function showError(form, msg) {
        const box = ensureErrorSummary(form);
        box.textContent = msg;
        box.style.display = 'block';
      }
      function hideError(form) {
        const box = $('.form-error-summary', form);
        if (box) box.style.display = 'none';
      }

      // ---------- Field validation ----------
      const emailOK = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
      const zipOK   = (v) => /^\d{5}(-?\d{4})?$/.test(v);
      const cleanDigits = (v) => (v || '').replace(/\D+/g, '');

      function validateForm(form) {
        hideError(form);

        // Required fields you collect server-side
        const requiredIds = [
          'firstName','lastName','phone','email',
          'streetAddress','city','state','zip'
        ];

        for (const id of requiredIds) {
          const el = $('#' + id, form);
          if (!el || !el.value || !el.value.trim()) {
            showError(form, 'Please fill out all required fields (marked with *).');
            el?.focus();
            return false;
          }
        }

        const email = $('#email', form).value.trim();
        if (!emailOK(email)) {
          showError(form, 'Please enter a valid email address.');
          $('#email', form).focus();
          return false;
        }

        const phoneRaw = $('#phone', form).value;
        const phoneDigits = cleanDigits(phoneRaw);
        if (phoneDigits.length < 10) {
          showError(form, 'Please enter a valid phone number (10 digits).');
          $('#phone', form).focus();
          return false;
        }

        const zip = $('#zip', form).value.trim();
        if (!zipOK(zip)) {
          showError(form, 'Please enter a valid ZIP code (5 or 9 digits).');
          $('#zip', form).focus();
          return false;
        }

        return true;
      }

      // ---------- Phone masking ----------
      function maskPhoneInput(e) {
        const input = e.target;
        const digits = input.value.replace(/\D+/g, '').slice(0, 10);
        let out = digits;

        if (digits.length > 6) out = `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
        else if (digits.length > 3) out = `(${digits.slice(0,3)}) ${digits.slice(3)}`;
        else if (digits.length > 0) out = `(${digits}`;

        input.value = out;
      }

      // ---------- ZIP → City/State autofill ----------  // NEW
      async function fillCityStateFromZip(zip, form) {    // NEW
        if (!/^\d{5}$/.test(zip)) return;                 // NEW
        try {                                             // NEW
          const res = await fetch(`https://api.zippopotam.us/us/${zip}`, { mode: 'cors' }); // NEW
          if (!res.ok) return;                            // NEW
          const data = await res.json();                  // NEW
          const place = (data.places && data.places[0]) || null; // NEW
          if (!place) return;                             // NEW
          const city = place['place name'] || '';         // NEW
          const stateAbbr = place['state abbreviation'] || ''; // NEW

          const cityEl = $('#city', form);                // NEW
          if (cityEl && !cityEl.value.trim()) {          // NEW (won't overwrite user input)
            cityEl.value = city;                          // NEW
          }                                               // NEW
          const stateEl = $('#state', form);              // NEW
          if (stateEl && !stateEl.readOnly && stateAbbr) {// NEW
            stateEl.value = stateAbbr;                    // NEW
          }                                               // NEW
        } catch (_) { /* silent */ }                      // NEW
      }                                                   // NEW

      // ---------- reCAPTCHA render ----------
      // We'll try to render once on load, and again on focus if needed.
      function renderRecaptchaIfPossible() {
        const host = window.grecaptcha && typeof window.grecaptcha.render === 'function';
        const container = document.getElementById('recaptcha') || document.querySelector('.g-recaptcha');
        if (!host || !container) return;

        // Avoid duplicate render
        if (typeof window._recaptchaWidgetId !== 'undefined') return;

        // Site key sources (pick the first you have):
        // 1) <div id="recaptcha" data-sitekey="..."></div>
        // 2) window.RECAPTCHA_SITE_KEY (set on the page)
        const sitekey = container.getAttribute('data-sitekey') || window.RECAPTCHA_SITE_KEY || '';
        if (!sitekey) return;

        try {
          window._recaptchaWidgetId = window.grecaptcha.render(container, { sitekey });
        } catch (e) {
          // noop
        }
      }

      // Some browsers load the API later; try a few times.
      function tryRenderRecaptchaWithRetries() {
        let tries = 0;
        const timer = setInterval(() => {
          tries++;
          renderRecaptchaIfPossible();
          if (typeof window._recaptchaWidgetId !== 'undefined' || tries > 20) {
            clearInterval(timer);
          }
        }, 300);
      }

      // ---------- Submit handler (includes recaptcha_token) ----------
      async function submitHandler(e) {
        e.preventDefault();
        const form = e.currentTarget;

        if (!validateForm(form)) return;

        // Collect reCAPTCHA token (required when RECAPTCHA_SECRET is set in Netlify)
        let token = '';
        if (window.grecaptcha && typeof window.grecaptcha.getResponse === 'function') {
          if (typeof window._recaptchaWidgetId !== 'undefined') {
            token = window.grecaptcha.getResponse(window._recaptchaWidgetId) || '';
          }
        }
        if (!token) {
          // Some themes add a hidden textarea; try that as a fallback
          const t = document.querySelector('textarea[name="g-recaptcha-response"]');
          if (t && t.value) token = t.value.trim();
        }
        if (!token) {
          showError(form, 'Please complete the reCAPTCHA before submitting.');
          return;
        }

        // Build payload (names must match your Netlify function expectations)
        const fd = new FormData(form);
        const data = {
          first_name:      (fd.get('first_name') || '').trim(),
          last_name:       (fd.get('last_name')  || '').trim(),
          phone:           (fd.get('phone')      || '').trim(),
          email:           (fd.get('email')      || '').trim(),
          street_address:  (fd.get('street_address') || '').trim(),
          city:            (fd.get('city')       || '').trim(),
          state:           (fd.get('state')      || '').trim(),
          zip:             (fd.get('zip')        || '').trim(),
          service_type:     fd.get('service_type')    || '',
          referral_source:  fd.get('referral_source') || '',
          description:     (fd.get('description')    || '').trim(),

          // ✅ NEW — required by your function when RECAPTCHA_SECRET is present
          recaptcha_token: token,

          // Helpful context in CRM/email
          page: location.href
        };

        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn ? submitBtn.textContent : null;
        if (submitBtn) { submitBtn.textContent = 'Submitting…'; submitBtn.disabled = true; }

        try {
          const res = await fetch('/.netlify/functions/jn-create-lead', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const text = await res.text();
          if (!res.ok) {
            // Surface server message if available
            let msg = 'Sorry, there was a problem submitting your request.';
            try {
              const json = JSON.parse(text);
              if (json && (json.error || json.message)) {
                msg = 'Error: ' + (json.error || json.message);
              }
            } catch (_) {}
            console.error('Lead submit failed:', text);
            showError(form, msg);
            return;
          }

          alert('Thanks! Your request has been submitted.');
          form.reset();
          hideError(form);

          if (window.grecaptcha &&
              typeof window.grecaptcha.reset === 'function' &&
              typeof window._recaptchaWidgetId !== 'undefined') {
            window.grecaptcha.reset(window._recaptchaWidgetId);
          } else {
            const t = document.querySelector('textarea[name="g-recaptcha-response"]');
            if (t) t.value = '';
          }

        } catch (err) {
          console.error(err);
          showError(form, 'Network error. Please try again.');
        } finally {
          if (submitBtn && originalText) {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
        }
      }

      // ---------- Boot ----------
      function attachBehaviors() {
        const form = document.getElementById('estimate-form');
        if (!form) return;

        // Phone mask
        const phone = $('#phone', form);
        if (phone) phone.addEventListener('input', maskPhoneInput);

        // ZIP → City/State autofill                         // NEW
        const zipEl = $('#zip', form);                       // NEW
        if (zipEl) {                                         // NEW
          const trigger = debounce(() => {                   // NEW
            const v = (zipEl.value || '').trim().slice(0, 5);// NEW
            if (/^\d{5}$/.test(v)) fillCityStateFromZip(v, form); // NEW
          }, 350);                                           // NEW
          zipEl.addEventListener('input', trigger);          // NEW
          zipEl.addEventListener('blur', () => {             // NEW
            const v = (zipEl.value || '').trim().slice(0, 5);// NEW
            if (/^\d{5}$/.test(v)) fillCityStateFromZip(v, form); // NEW
          });                                                // NEW
        }                                                    // NEW

        // Try to render reCAPTCHA now (and again on first focus)
        tryRenderRecaptchaWithRetries();
        form.addEventListener('focusin', renderRecaptchaIfPossible, { once: true });

        // Submit wiring
        form.addEventListener('submit', submitHandler);
      }

      // ✅ Expose init so your include loader can run it after injecting the hero
      window.initEstimateForm = attachBehaviors;

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachBehaviors);
      } else {
        attachBehaviors();
      }
    })();
  </script>
</body>
</html>
